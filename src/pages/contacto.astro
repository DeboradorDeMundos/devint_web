---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/common/Header.astro';
import Footer from '../components/common/Footer.astro';
---

<BaseLayout 
  title="Contacto - Devint | Cotiza tu Proyecto"
  description="Contáctanos para discutir tu próximo proyecto de desarrollo de software, consultoría SAP o solución tecnológica. ¡Cotización sin compromiso!"
>
  <Header />
  
  <main class="pt-20">
    <!-- Hero Section -->
    <section class="py-20 relative">
      <div class="absolute inset-0 opacity-30">
        <img src="/images/digital-communication-technology-background-with-hand-touching-virtual-screen-digital-remix.jpg" alt="Contact Background" class="w-full h-full object-cover" />
      </div>

      <div class="container mx-auto px-6 relative z-10">
        <div class="text-center max-w-4xl mx-auto">
          <h1 class="text-5xl lg:text-6xl font-bold text-white mb-6">
            HABLEMOS DE TU
            <span class="bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">
              PROYECTO
            </span>
          </h1>
          <p class="text-xl text-slate-300 leading-relaxed">
            Estamos listos para escuchar tu idea y ayudarte a convertirla en realidad digital
          </p>
        </div>
      </div>
    </section>

    <section class="py-20">
      <div class="container mx-auto px-6">
        <div class="grid lg:grid-cols-2 gap-16">
          
          <!-- Contact Form -->
          <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-3xl p-8">
            <h2 class="text-3xl font-bold text-white mb-8">Envíanos un mensaje</h2>
            
            <form class="space-y-6" id="contactForm">
              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label for="nombre" class="block text-sm font-medium text-slate-300 mb-2">
                    Nombre *
                  </label>
                  <input 
                    type="text" 
                    id="nombre" 
                    name="nombre" 
                    required
                    class="w-full px-4 py-3 bg-slate-900/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-colors"
                    placeholder="Tu nombre"
                  />
                  <p class="mt-2 hidden text-sm text-red-400" data-error-for="nombre"></p>
                </div>
                <div>
                  <label for="empresa" class="block text-sm font-medium text-slate-300 mb-2">
                    Empresa
                  </label>
                  <input 
                    type="text" 
                    id="empresa" 
                    name="empresa"
                    class="w-full px-4 py-3 bg-slate-900/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-colors"
                    placeholder="Nombre de tu empresa"
                  />
                  <p class="mt-2 hidden text-sm text-red-400" data-error-for="empresa"></p>
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label for="email" class="block text-sm font-medium text-slate-300 mb-2">
                    Email *
                  </label>
                  <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    required
                    class="w-full px-4 py-3 bg-slate-900/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-colors"
                    placeholder="tu@email.com"
                  />
                  <p class="mt-2 hidden text-sm text-red-400" data-error-for="email"></p>
                </div>
                <div>
                  <label for="telefono" class="block text-sm font-medium text-slate-300 mb-2">
                    Teléfono
                  </label>
                  <input 
                    type="tel" 
                    id="telefono" 
                    name="telefono"
                    class="w-full px-4 py-3 bg-slate-900/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-colors"
                    placeholder="+56 9 XXXX XXXX"
                  />
                  <p class="mt-2 hidden text-sm text-red-400" data-error-for="telefono"></p>
                </div>
              </div>

              <div>
                <label for="servicio" class="block text-sm font-medium text-slate-300 mb-2">
                  Servicio de interés *
                </label>
                <select 
                  id="servicio" 
                  name="servicio" 
                  required
                  class="w-full px-4 py-3 bg-slate-900/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-colors"
                >
                  <option value="">Selecciona un servicio</option>
                  <option value="desarrollo-software">Desarrollo de Software</option>
                  <option value="app-moviles">Aplicaciones Móviles</option>
                  <option value="pagina-web">Página Web</option>
                  <option value="webapp">Aplicación Web</option>
                  <option value="integraciones">Integraciones</option>
                  <option value="consultoria-sap">Consultoría SAP</option>
                  <option value="cloud">Servicios Cloud</option>
                  <option value="diseno">Diseño</option>
                  <option value="refactorizacion">Refactorización</option>
                  <option value="otro">Otro</option>
                </select>
                <p class="mt-2 hidden text-sm text-red-400" data-error-for="servicio"></p>
              </div>

              <div>
                <label for="presupuesto" class="block text-sm font-medium text-slate-300 mb-2">
                  Presupuesto aproximado
                </label>
                <select 
                  id="presupuesto" 
                  name="presupuesto"
                  class="w-full px-4 py-3 bg-slate-900/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-colors"
                >
                  <option value="">Selecciona un rango</option>
                  <option value="menos-1m">Menos de $1.000.000</option>
                  <option value="1m-3m">$1.000.000 - $3.000.000</option>
                  <option value="3m-5m">$3.000.000 - $5.000.000</option>
                  <option value="5m-10m">$5.000.000 - $10.000.000</option>
                  <option value="mas-10m">Más de $10.000.000</option>
                  <option value="por-definir">Por definir</option>
                </select>
                <p class="mt-2 hidden text-sm text-red-400" data-error-for="presupuesto"></p>
              </div>

              <div>
                <label for="mensaje" class="block text-sm font-medium text-slate-300 mb-2">
                  Cuéntanos sobre tu proyecto *
                </label>
                <textarea 
                  id="mensaje" 
                  name="mensaje" 
                  required
                  rows="6"
                  class="w-full px-4 py-3 bg-slate-900/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-colors resize-none"
                  placeholder="Describe tu proyecto, objetivos, plazos y cualquier información relevante..."
                ></textarea>
                <p class="mt-2 hidden text-sm text-red-400" data-error-for="mensaje"></p>
              </div>

              <div class="hidden rounded-2xl border border-slate-700 bg-slate-900/60 p-4 text-sm" id="form-message" role="alert"></div>

              <button 
                type="submit"
                class="w-full bg-gradient-to-r from-emerald-500 to-cyan-500 text-white px-8 py-4 rounded-full font-semibold hover:from-emerald-600 hover:to-cyan-600 transition-all duration-300 shadow-lg hover:shadow-emerald-500/25 flex items-center justify-center space-x-2"
              >
                <span>Enviar Mensaje</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
              </button>
            </form>
          </div>

          <!-- Contact Info -->
          <div class="space-y-8">
            <div>
              <h2 class="text-3xl font-bold text-white mb-6">Información de Contacto</h2>
              <p class="text-lg text-slate-300 leading-relaxed mb-8">
                Responderemos tu consulta en un máximo de 24 horas. También puedes contactarnos directamente a través de los siguientes canales.
              </p>
            </div>

            <div class="space-y-6">
              <!-- Email -->
              <div class="flex items-start space-x-4 p-6 bg-slate-800/30 rounded-2xl backdrop-blur-sm border border-slate-700">
                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-cyan-500 rounded-xl flex items-center justify-center flex-shrink-0">
                  <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-white mb-2">Email</h3>
                  <p class="text-slate-300">contacto@devint.cl</p>
                  <p class="text-slate-400 text-sm">Respuesta en 24 hrs</p>
                </div>
              </div>

              <!-- Teléfono -->
              <div class="flex items-start space-x-4 p-6 bg-slate-800/30 rounded-2xl backdrop-blur-sm border border-slate-700">
                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-cyan-500 rounded-xl flex items-center justify-center flex-shrink-0">
                  <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-white mb-2">Teléfono</h3>
                  <p class="text-slate-300">+56 9 XXXX XXXX</p>
                  <p class="text-slate-400 text-sm">Lunes a Viernes 9:00 - 18:00</p>
                </div>
              </div>

              <!-- Ubicación -->
              <div class="flex items-start space-x-4 p-6 bg-slate-800/30 rounded-2xl backdrop-blur-sm border border-slate-700">
                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-cyan-500 rounded-xl flex items-center justify-center flex-shrink-0">
                  <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-white mb-2">Ubicación</h3>
                  <p class="text-slate-300">Santiago, Chile</p>
                  <p class="text-slate-400 text-sm">Servicios presenciales y remotos</p>
                </div>
              </div>
            </div>

            <!-- Process Timeline -->
            <div class="bg-slate-800/30 rounded-2xl p-6 backdrop-blur-sm border border-slate-700">
              <h3 class="text-lg font-semibold text-white mb-6">¿Cómo trabajamos?</h3>
              <div class="space-y-4">
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center text-white text-sm font-bold">1</div>
                  <p class="text-slate-300">Conversación inicial y análisis de requerimientos</p>
                </div>
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center text-white text-sm font-bold">2</div>
                  <p class="text-slate-300">Propuesta técnica y cotización detallada</p>
                </div>
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center text-white text-sm font-bold">3</div>
                  <p class="text-slate-300">Desarrollo con entregas parciales y feedback constante</p>
                </div>
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center text-white text-sm font-bold">4</div>
                  <p class="text-slate-300">Testing, puesta en producción y soporte</p>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

  </main>
  
  <Footer />
</BaseLayout>

<script type="module">
  import {
    validateEmail,
    validateField,
    validatePhone,
    sanitizeInput,
  } from "../utils/validation";

  const form = document.getElementById("contactForm");
  const messageBox = document.getElementById("form-message");

  const showMessage = (type, message) => {
    if (!messageBox) return;
    messageBox.textContent = message;
    messageBox.classList.remove(
      "hidden",
      "text-emerald-200",
      "text-emerald-300",
      "text-red-300",
      "border",
      "border-emerald-500/40",
      "border-red-500/40"
    );

    if (type === "success") {
      messageBox.classList.add("text-emerald-200", "border", "border-emerald-500/40");
    } else {
      messageBox.classList.add("text-red-300", "border", "border-red-500/40");
    }
  };

  const hideMessage = () => {
    if (!messageBox) return;
    messageBox.classList.add("hidden");
    messageBox.textContent = "";
  };

  const setFieldError = (field, errors) => {
    const fieldError = document.querySelector(`[data-error-for="${field}"]`);
    const input = document.querySelector(`[name="${field}"]`);

    if (!fieldError || !input) return;

    if (errors.length > 0) {
      fieldError.textContent = errors[0];
      fieldError.classList.remove("hidden");
      input.setAttribute("aria-invalid", "true");
    } else {
      fieldError.textContent = "";
      fieldError.classList.add("hidden");
      input.removeAttribute("aria-invalid");
    }
  };

  const clearErrors = () => {
    document
      .querySelectorAll("[data-error-for]")
      .forEach((element) => element.classList.add("hidden"));

    document
      .querySelectorAll("[aria-invalid='true']")
      .forEach((element) => element.removeAttribute("aria-invalid"));
  };

  form?.addEventListener("submit", async (event) => {
    event.preventDefault();

    if (!form) return;

    hideMessage();
    clearErrors();

    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());

    const normalized = {
      nombre: sanitizeInput(String(payload.nombre ?? "")),
      empresa: sanitizeInput(String(payload.empresa ?? "")),
      email: sanitizeInput(String(payload.email ?? "")),
      telefono: sanitizeInput(String(payload.telefono ?? "")),
      servicio: String(payload.servicio ?? ""),
      presupuesto: String(payload.presupuesto ?? ""),
      mensaje: sanitizeInput(String(payload.mensaje ?? "")),
    };

    const validations = {
      nombre: validateField(normalized.nombre, {
        required: true,
        minLength: 3,
        message: "Ingresa tu nombre completo",
      }),
      email: validateEmail(normalized.email),
      servicio: validateField(normalized.servicio, {
        required: true,
        message: "Selecciona el servicio de interés",
      }),
      mensaje: validateField(normalized.mensaje, {
        required: true,
        minLength: 20,
        message: "Cuéntanos más detalles para ayudarte mejor",
      }),
    };

    if (normalized.telefono) {
      validations.telefono = validatePhone(normalized.telefono);
    }

    let hasErrors = false;
    Object.entries(validations).forEach(([field, result]) => {
      setFieldError(field, result.errors ?? []);
      if (!result.isValid) {
        hasErrors = true;
      }
    });

    if (hasErrors) {
      showMessage("error", "Revisa los campos marcados antes de enviar.");
      return;
    }

    const submitBtn = form.querySelector("button[type='submit']");
    const originalText = submitBtn?.innerHTML ?? "Enviar";

    if (submitBtn) {
      submitBtn.setAttribute("disabled", "true");
      submitBtn.classList.remove("hover:from-emerald-600", "hover:to-cyan-600");
      submitBtn.innerHTML = `
        <span>Enviando...</span>
        <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v4m0 8v4m8-8h-4M8 12H4m12.364-5.364l-2.828 2.828m-5.656 5.656l-2.828 2.828m0-11.312l2.828 2.828m5.656 5.656l2.828 2.828" />
        </svg>`;
    }

    try {
      const response = await fetch("/api/contact", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(normalized),
      });

      if (!response.ok) {
        throw new Error("No pudimos procesar tu mensaje. Inténtalo nuevamente.");
      }

      showMessage("success", "¡Gracias! Tu mensaje fue enviado. Te contactaremos dentro de las próximas 24 horas.");
      form.reset();
    } catch (error) {
      showMessage(
        "error",
        error instanceof Error ? error.message : "Ocurrió un problema inesperado. Inténtalo nuevamente más tarde."
      );
    } finally {
      if (submitBtn) {
        submitBtn.innerHTML = originalText;
        submitBtn.removeAttribute("disabled");
        submitBtn.classList.add("hover:from-emerald-600", "hover:to-cyan-600");
      }
    }
  });
</script>
